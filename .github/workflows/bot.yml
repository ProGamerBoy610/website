# .github/workflows/bot.yml
# This file MUST be placed in: .github/workflows/bot.yml

name: Discord Bot 24/7

on:
  push:
    branches: [main, master]
  schedule:
    # Runs every 6 hours (00:00, 06:00, 12:00, 18:00 UTC)
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual restart'
        required: false
        default: 'Manual restart'

jobs:
  run-bot:
    name: Run Discord Bot
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours maximum
    
    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4
      
    - name: 🟢 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: 📦 Install Dependencies
      run: |
        echo "📦 Installing npm packages..."
        npm install --production
        echo "✅ Dependencies installed!"
        
    - name: 🔍 Verify Files
      run: |
        echo "🔍 Checking required files..."
        ls -la
        if [ ! -f "bot.js" ]; then
          echo "❌ bot.js not found!"
          exit 1
        fi
        if [ ! -f "package.json" ]; then
          echo "❌ package.json not found!"
          exit 1
        fi
        echo "✅ All files verified!"
        
    - name: 🤖 Start Discord Bot
      env:
        DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
        GITHUB_ACTIONS: 'true'
      run: |
        echo "🚀 Starting Discord bot..."
        echo "📅 Start time: $(date)"
        echo "🔄 Will run for maximum 6 hours"
        
        # Run bot with timeout (6 hours = 21600 seconds)
        timeout 21600 node bot.js || {
          exit_code=$?
          if [ $exit_code -eq 124 ]; then
            echo "✅ Bot session completed (6 hour timeout reached)"
            echo "🔄 Next session will start automatically"
          else
            echo "⚠️ Bot exited with code $exit_code"
          fi
        }
        
        echo "📊 Bot session ended at: $(date)"
        
    - name: 📋 Session Summary
      if: always()
      run: |
        echo "📊 === BOT SESSION SUMMARY ==="
        echo "🕐 Session duration: Up to 6 hours"
        echo "🔄 Next automatic run: Every 6 hours"
        echo "📅 Current time: $(date)"
        echo "🎯 Repository: ${{ github.repository }}"
        echo "🔧 Triggered by: ${{ github.event_name }}"
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "📝 Manual reason: ${{ github.event.inputs.reason }}"
        fi
        echo "✅ Session completed successfully!"
