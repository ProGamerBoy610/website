# .github/workflows/bot.yml
# This file MUST be placed in: .github/workflows/bot.yml

name: Discord Bot 24/7

on:
  push:
    branches: [main, master]
  schedule:
    # Runs every 6 hours (00:00, 06:00, 12:00, 18:00 UTC)
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual restart'
        required: false
        default: 'Manual restart'

jobs:
  run-bot:
    name: Run Discord Bot
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours maximum
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        echo "ğŸ“¦ Installing npm packages..."
        npm install --production
        echo "âœ… Dependencies installed!"
        
    - name: ğŸ” Verify Files
      run: |
        echo "ğŸ” Checking required files..."
        ls -la
        if [ ! -f "bot.js" ]; then
          echo "âŒ bot.js not found!"
          exit 1
        fi
        if [ ! -f "package.json" ]; then
          echo "âŒ package.json not found!"
          exit 1
        fi
        echo "âœ… All files verified!"
        
    - name: ğŸ¤– Start Discord Bot
      env:
        DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
        GITHUB_ACTIONS: 'true'
      run: |
        echo "ğŸš€ Starting Discord bot..."
        echo "ğŸ“… Start time: $(date)"
        echo "ğŸ”„ Will run for maximum 6 hours"
        
        # Run bot with timeout (6 hours = 21600 seconds)
        timeout 21600 node bot.js || {
          exit_code=$?
          if [ $exit_code -eq 124 ]; then
            echo "âœ… Bot session completed (6 hour timeout reached)"
            echo "ğŸ”„ Next session will start automatically"
          else
            echo "âš ï¸ Bot exited with code $exit_code"
          fi
        }
        
        echo "ğŸ“Š Bot session ended at: $(date)"
        
    - name: ğŸ“‹ Session Summary
      if: always()
      run: |
        echo "ğŸ“Š === BOT SESSION SUMMARY ==="
        echo "ğŸ• Session duration: Up to 6 hours"
        echo "ğŸ”„ Next automatic run: Every 6 hours"
        echo "ğŸ“… Current time: $(date)"
        echo "ğŸ¯ Repository: ${{ github.repository }}"
        echo "ğŸ”§ Triggered by: ${{ github.event_name }}"
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "ğŸ“ Manual reason: ${{ github.event.inputs.reason }}"
        fi
        echo "âœ… Session completed successfully!"
